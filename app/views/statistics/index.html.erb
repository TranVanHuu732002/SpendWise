<div class="min-vh-100 bg-light py-5 d-flex align-items-center justify-content-center">
  <div class="container bg-white shadow rounded p-4">
    <h1 class="display-5 fw-bold mb-4 text-center text-primary">📊 Thống kê chi tiêu</h1>
    <div class="row g-4">
      <!-- Left: Bảng thống kê -->
      <div class="col-md-6">
        <div class="mb-4" data-controller="statistics-table"
          data-statistics-table-category='<%= raw @category_stats.to_json %>'
          data-statistics-table-month='<%= raw @monthly_stats.to_json %>'
          data-statistics-table-year='<%= raw @yearly_stats.to_json %>'>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <div class="d-flex align-items-center gap-2">
                <label for="tableTypeSelect" class="form-label fw-semibold text-primary mb-0">Chọn loại bảng</label>
                <select id="tableTypeSelect" data-action="change->statistics-table#changeType" class="form-select">
                  <option value="categories">Theo danh mục</option>
                  <option value="monthly">Theo tháng</option>
                  <option value="yearly">Theo năm</option>
                </select>
              </div>
            </div>
            <!-- Export Button -->
            <div>
              <form id="exportForm" action="<%= statistics_path(format: :csv) %>" method="get">
                <input type="hidden" id="exportType" name="type" value="categories" data-statistics-table-target="exportType">
                <button type="submit" class="btn btn-primary">
                  Xuất báo cáo
                </button>
              </form>
            </div>
          </div>
          <table id="statisticsTable" class="table table-bordered table-hover mb-4">
            <thead class="table-light">
              <tr id="tableHeader">
                <th class="text-center">Danh mục</th>
                <th class="text-center">Số tiền</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <% @category_stats.each do |category, amount| %>
                <tr>
                  <td class="text-center"><%= category %></td>
                  <td class="text-end text-success fw-bold"><%= number_to_currency(amount, unit: "₫", precision: 0) %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
      <!-- Right: Biểu đồ -->
      <div class="col-md-6 d-flex flex-column align-items-center">
        <div class="w-100 d-flex flex-column align-items-center" data-controller="statistics-chart"
          data-statistics-chart-labels='<%= raw @monthly_stats.keys.to_json %>' 
          data-statistics-chart-data='<%= raw @monthly_stats.values.to_json %>' 
          data-statistics-chart-year-labels='<%= raw @yearly_stats.keys.to_json %>'
          data-statistics-chart-year-data='<%= raw @yearly_stats.values.to_json %>'
          data-statistics-chart-type="bar">
          <div class="mb-3 w-100 text-center">
            <label for="chartTypeSelect" class="form-label fw-semibold text-primary">Chọn loại biểu đồ</label>
            <select id="chartTypeSelect" data-statistics-chart-target="select" data-action="change->statistics-chart#changeType" class="form-select mx-auto" style="max-width: 300px;">
              <option value="month">Biểu đồ theo tháng</option>
              <option value="year">Biểu đồ theo năm</option>
            </select>
          </div>
          <div class="bg-white rounded shadow p-3 w-100 d-flex justify-content-center">
            <canvas 
              id="statisticsChart"
              data-statistics-chart-target="canvas"
              width="400" height="400">
            </canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<% Rails.logger.info "Monthly stats keys: #{raw @monthly_stats.keys.to_json}" %>
<% Rails.logger.info "Monthly stats values: #{raw @monthly_stats.values.to_json}" %>
<% Rails.logger.info "Yearly stats keys: #{raw @yearly_stats.keys.to_json}" %>
<% Rails.logger.info "Yearly stats values: #{raw @yearly_stats.values.to_json}" %>
